#!/usr/bin/env zsh
# ===============================================
# zsh loads this file only if it is a login-shell
# ===============================================

# start graphical session
if systemctl -q is-active graphical.target && [[ -z $DISPLAY && $XDG_VTNR -eq 1 && ( -z $XDG_SESSION_TYPE || $XDG_SESSION_TYPE == tty ) && $OSNAME == "Arch" ]]; then
  echo -n "Select WM/DE [bspwm, gnome(-x11), i3, kde, lxqt, sway] [default: sway]:\n>>> "
  read wm
  if [[ -z $wm ]]; then
    wm="sway"
  fi

  if [[ $wm == "exit" ]]; then
    exit 0
  fi

  # for wayland
  if [[ $wm == (sway|gnome) ]]; then
    # set xdg env var
    export XDG_SESSION_TYPE=wayland

    # set qt
    export QT_QPA_PLATFORM=wayland
    export QT_QPA_PLATFORMTHEME=qt5ct

    # set IM
    export XMODIFIERS=@im=fcitx
    export GTK_IM_MODULE=fcitx
    export QT_IM_MODULE=fcitx
    export GLFW_IM_MODULE=fcitx

    # set firefox
    export MOZ_ENABLE_WAYLAND=1

    if [[ $wm == sway ]]; then
      # start sway
      export XDG_CURRENT_DESKTOP=sway
      systemctl --user set-environment XDG_CURRENT_DESKTOP=sway

      # use old api
      # new api locks 288fps and reduce game performance when using --custom output flag
      # export WLR_DRM_NO_ATOMIC=1

      exec sway
    elif [[ $wm == gnome ]]; then
      exec dbus-run-session gnome-session
    fi
    exit 0

  else # for X session
    # start X session
    exec startx ~/.xinitrc $wm -- -maxclients 2048
  fi
fi

# load machine local profile
[[ -f $ZDOTDIR/.zprofile.local ]] && source $ZDOTDIR/.zprofile.local

# vim: sw=2 et
